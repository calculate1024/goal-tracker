<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src  'self' https://accounts.google.com;
    style-src   'self' 'unsafe-inline';
    connect-src 'self' https://gmail.googleapis.com https://api.anthropic.com https://oauth2.googleapis.com;
    frame-src   https://accounts.google.com;
    img-src     'self' data:;
    font-src    'self';
    object-src  'none';
    base-uri    'self';
    form-action 'self';
    frame-ancestors 'none';
  ">
  <title>AI郵件分析目標追蹤系統</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app">

    <!-- ============================
         Block: app（頁面容器）
         ============================ -->
    <header class="app__header">
      <h1 class="app__title">AI郵件分析目標追蹤系統</h1>
      <p class="app__subtitle">把大目標拆成小步驟，每天看見自己的進步</p>
      <button class="app__settings-btn" id="openSettingsBtn" type="button" aria-label="設定">
        &#9881;
      </button>
    </header>

    <main class="app__main">

      <!-- ============================
           Block: dashboard（儀表板）
           ============================ -->
      <section class="dashboard" aria-label="統計儀表板">
        <div class="dashboard__card">
          <span class="dashboard__number" id="totalCount">0</span>
          <span class="dashboard__label">全部目標</span>
        </div>
        <div class="dashboard__card">
          <span class="dashboard__number" id="completedCount">0</span>
          <span class="dashboard__label">已完成</span>
        </div>
        <div class="dashboard__card dashboard__card--success">
          <span class="dashboard__number" id="onTrackCount">0</span>
          <span class="dashboard__label">進行中</span>
        </div>
        <div class="dashboard__card dashboard__card--danger">
          <span class="dashboard__number" id="overdueCount">0</span>
          <span class="dashboard__label">已逾期</span>
        </div>
      </section>

      <button class="email-to-goal-btn" id="emailToGoalBtn" type="button">
        ✨ 從 Gmail 獲取 AI 建議目標
      </button>

      <!-- ============================
           Block: goal-list（目標列表區）
           包含: filter, goal-form 觸發鈕, 掛載點
           ============================ -->
      <section class="goal-list" aria-label="目標列表">

        <!-- Block: filter（篩選列） -->
        <nav class="filter" aria-label="篩選與排序">
          <div class="filter__group">
            <select class="filter__select" id="filterCategory" aria-label="分類篩選">
              <option value="all">全部分類</option>
            </select>
            <select class="filter__select" id="filterStatus" aria-label="狀態篩選">
              <option value="all">全部狀態</option>
              <option value="active">進行中</option>
              <option value="completed">已完成</option>
            </select>
          </div>
          <select class="filter__select" id="sortBy" aria-label="排序方式">
            <option value="deadline">依截止日排序</option>
            <option value="createdAt">依建立日排序</option>
            <option value="progress">依進度排序</option>
          </select>
        </nav>

        <!-- Block: goal-form（新增目標觸發鈕） -->
        <button class="goal-form__open-button" id="openFormBtn" type="button">
          + 新增目標
        </button>

        <!--
          掛載點：renderer.js 將在此動態渲染以下 BEM Block：
          - .goal-card          （單一目標卡片）
          - .goal-card__title   （目標標題）
          - .progress-bar       （進度條）
          - .subtask            （子任務項目）
          - .category-tag       （分類標籤）
        -->
        <div class="goal-list__container" id="goalContainer"></div>

      </section>

      <!-- 匯出 / 匯入 -->
      <footer class="app__footer">
        <div class="app__backup-actions">
          <button class="app__export-button" id="exportBtn" type="button">
            匯出 JSON 備份
          </button>
          <button class="app__import-button" id="importBtn" type="button">
            匯入備份檔案
          </button>
          <input type="file" id="importFileInput" accept=".json" hidden>
        </div>
        <p class="app__backup-hint">🔒 資料僅儲存於本地，建議定期備份以防遺失。</p>
      </footer>

    </main>
  </div>

  <!-- ============================
       Block: modal（彈窗）
       Block: goal-form（新增 / 編輯表單）
       ============================ -->
  <div class="modal" id="goalModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal__overlay" id="modalOverlay"></div>
    <div class="modal__content">
      <header class="modal__header">
        <h2 class="modal__title" id="modalTitle">新增目標</h2>
        <button class="modal__close" id="modalClose" type="button" aria-label="關閉">&times;</button>
      </header>

      <form class="goal-form" id="goalForm">
        <div class="goal-form__field">
          <label class="goal-form__label" for="goalTitle">目標名稱</label>
          <input
            class="goal-form__input"
            id="goalTitle"
            type="text"
            placeholder="例：每週運動 3 次"
            autocomplete="off"
            required
          >
        </div>

        <div class="goal-form__field">
          <label class="goal-form__label" for="goalCategory">分類</label>
          <select class="goal-form__input" id="goalCategory">
            <!-- 由 renderer.js 動態填入 category-tag 選項 -->
          </select>
        </div>

        <div class="goal-form__field">
          <label class="goal-form__label" for="goalDeadline">截止日期</label>
          <input class="goal-form__input" id="goalDeadline" type="date">
        </div>

        <div class="goal-form__field">
          <label class="goal-form__label" id="subtaskLabel">子任務</label>
          <div class="goal-form__subtasks" id="subtaskContainer" role="group" aria-labelledby="subtaskLabel">
            <!-- 由 app.js 動態新增 subtask 輸入列 -->
          </div>
          <button class="goal-form__add-subtask" id="addSubtaskBtn" type="button">
            + 新增子任務
          </button>
        </div>

        <input type="hidden" id="goalId">
        <button class="goal-form__submit" type="submit">儲存</button>
      </form>
    </div>
  </div>

  <!-- ============================
       Block: modal（設定彈窗）
       Block: settings（設定表單）
       ============================ -->
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal__overlay" id="settingsOverlay"></div>
    <div class="modal__content">
      <header class="modal__header">
        <h2 class="modal__title" id="settingsTitle">設定</h2>
        <button class="modal__close" id="settingsClose" type="button" aria-label="關閉">&times;</button>
      </header>

      <form class="settings" id="settingsForm">
        <div class="settings__field">
          <label class="settings__label" for="googleClientId">Google Client ID</label>
          <input
            class="settings__input"
            id="googleClientId"
            type="password"
            placeholder="xxxx.apps.googleusercontent.com"
            autocomplete="off"
          >
        </div>

        <div class="settings__field">
          <label class="settings__label" for="aiApiKey">AI API Key</label>
          <input
            class="settings__input"
            id="aiApiKey"
            type="password"
            placeholder="sk-... 或 anthropic key"
            autocomplete="off"
          >
        </div>

        <div class="settings__actions">
          <button class="settings__save-key-btn" id="saveApiKeyBtn" type="button">
            儲存新金鑰
          </button>
          <span class="settings__key-result" id="keyResult"></span>
        </div>

        <div class="settings__actions">
          <button class="settings__test-btn" id="testConnectionBtn" type="button">
            連線測試
          </button>
          <span class="settings__test-result" id="testResult"></span>
        </div>

        <div class="settings__gmail-auth">
          <button class="settings__gmail-btn" id="connectGmailBtn" type="button">
            連結 Gmail 帳號
          </button>
          <button class="settings__gmail-btn settings__gmail-btn--disconnect"
                  id="disconnectGmailBtn" type="button" hidden>
            解除綁定
          </button>
          <span class="settings__gmail-status" id="gmailAuthStatus"></span>
        </div>

        <div class="settings__field">
          <label class="settings__label">匯入備份</label>
          <div class="settings__actions">
            <button class="settings__import-btn" id="settingsImportBtn" type="button">
              選擇 JSON 檔案
            </button>
            <input type="file" id="settingsImportFile" accept=".json" hidden>
            <span class="settings__import-result" id="settingsImportResult"></span>
          </div>
        </div>

        <button class="settings__save-btn" type="submit">儲存設定</button>
      </form>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Google Identity Services（非同步載入） -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- 單一進入點，以 ES Module 載入 -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
